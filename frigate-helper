#!/bin/bash
set -e

# Farben für die Anzeige
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

echo -e "${GREEN}=== Frigate LXC Installationsassistent ===${RESET}"

# Schritt 1: Verfügbare Debian-Templates anzeigen
echo -e "${YELLOW}Verfügbare Debian LXC Templates:${RESET}"
TEMPLATES=($(ls /var/lib/vz/template/cache/debian-*-standard_*.tar.zst))
for i in "${!TEMPLATES[@]}"; do
    echo "[$i] ${TEMPLATES[$i]}"
done
read -p "Wähle ein Template (Zahl eingeben): " TEMPLATE_INDEX
TEMPLATE="${TEMPLATES[$TEMPLATE_INDEX]}"
echo "Gewähltes Template: $TEMPLATE"

# Schritt 2: Verfügbare Storages anzeigen
echo -e "${YELLOW}Verfügbare Storages:${RESET}"
STORAGES=($(pvesm status | awk 'NR>1 {print $1}'))
for i in "${!STORAGES[@]}"; do
    echo "[$i] ${STORAGES[$i]}"
done
read -p "Wähle einen Storage für den Container (Zahl eingeben): " STORAGE_INDEX
STORAGE="${STORAGES[$STORAGE_INDEX]}"
echo "Gewählter Storage: $STORAGE"

# Schritt 3: Container-ID (CTID) abfragen
read -p "Gib die gewünschte Container-ID (CTID) ein: " CTID

# Schritt 4: Container-Name
read -p "Gib einen Namen für den Container ein: " CT_NAME

# Schritt 5: Netzwerk konfigurieren
echo -e "${YELLOW}Netzwerk konfigurieren:${RESET}"
echo "1) DHCP"
echo "2) Feste IP"
read -p "Wähle die Netzwerkkonfiguration: " NET_OPT
if [[ "$NET_OPT" == "2" ]]; then
    read -p "Gib die feste IP ein (z.B. 192.168.1.100/24): " CT_IP
    read -p "Gib das Gateway ein (z.B. 192.168.1.1): " CT_GW
    NET_CMD="--net0 name=eth0,bridge=vmbr0,ip=${CT_IP},gw=${CT_GW}"
else
    NET_CMD="--net0 name=eth0,bridge=vmbr0,ip=dhcp"
fi

# Schritt 6: Zusammenfassung
echo -e "${GREEN}=== Zusammenfassung ===${RESET}"
echo "Template: $TEMPLATE"
echo "Storage: $STORAGE"
echo "CTID: $CTID"
echo "Container-Name: $CT_NAME"
echo "Netzwerk: $NET_CMD"

read -p "Alles korrekt? Starte Installation (j/n): " CONFIRM
if [[ "$CONFIRM" != "j" ]]; then
    echo "Installation abgebrochen."
    exit 1
fi

# Schritt 7: Container erstellen
echo -e "${GREEN}Erstelle LXC Container...${RESET}"
pct create $CTID /var/lib/vz/template/cache/$TEMPLATE \
    --hostname $CT_NAME \
    --storage $STORAGE \
    --cores 2 \
    --memory 2048 \
    --swap 512 \
    $NET_CMD \
    --features nesting=1 \
    --unprivileged 1

# Schritt 8: Container starten
echo -e "${GREEN}Starte Container...${RESET}"
pct start $CTID

# Schritt 9: Docker & Frigate installieren
echo -e "${GREEN}Installiere Docker und Frigate im Container...${RESET}"
pct exec $CTID -- bash -c "apt update && apt install -y curl gnupg lsb-release && \
curl -fsSL https://get.docker.com | sh && \
docker run -d --name frigate --restart=unless-stopped -p 5000:5000 blakeblackshear/frigate:stable"

echo -e "${GREEN}=== Installation abgeschlossen! ===${RESET}"
echo "Zugriff auf Frigate: http://<Container-IP>:5000"
