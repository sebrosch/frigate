#!/bin/bash

# ---------------------------
# Frigate Helper Script v9.0
# Automatische Template-Erkennung (Debian 12) ohne jq
# ---------------------------

FRIGATE_DIR="/opt/frigate"
GITHUB_REPO="frigate"
ACTION=""

show_help() {
    echo "Usage: $0 create [--storage STORAGE_NAME]"
    echo ""
    echo "Options:"
    echo "  --storage STORAGE_NAME   Wähle den Proxmox Storage für den Container (optional)"
    echo "  --help                   Zeigt dieses Hilfemenü"
    exit 0
}

# Parameter auslesen
while [[ $# -gt 0 ]]; do
    case $1 in
        --storage)
            STORAGE="$2"
            shift 2
            ;;
        --help)
            show_help
            ;;
        create)
            ACTION="create"
            shift
            ;;
        *)
            echo "Unbekannte Option: $1"
            show_help
            ;;
    esac
done

if [[ "$ACTION" != "create" ]]; then
    show_help
fi

echo "=== Starte Frigate Installation ==="

# Prüfen /opt/frigate
if [ -d "$FRIGATE_DIR" ]; then
    echo "Altes /opt/frigate Verzeichnis gefunden, lösche es..."
    rm -rf "$FRIGATE_DIR"
fi

# Repo klonen (öffentlich)
echo "Klonen des öffentlichen Repos..."
git clone https://github.com/sebrosch/$GITHUB_REPO.git "$FRIGATE_DIR" --branch main
chmod +x "$FRIGATE_DIR/frigate-helper"

# Storage Standardwert setzen
if [ -z "$STORAGE" ]; then
    STORAGE="local"
fi

# LXC Template automatisch suchen
TEMPLATE=$(ls /var/lib/vz/template/cache/ | grep 'debian-12-standard.*\.tar\.zst' | head -n1)

if [ -z "$TEMPLATE" ]; then
    echo "Fehler: Kein Debian 12 Template gefunden. Bitte ein Template unter /var/lib/vz/template/cache/ ablegen."
    exit 1
fi

echo "Verwende Storage: $STORAGE"
echo "Verwende Template: $TEMPLATE"

# CTID ermitteln
NEXT_CID=$(pvesh get /cluster/nextid)
echo "CTID: $NEXT_CID"

# Prüfen, ob Container existiert
if pct status $NEXT_CID &>/dev/null; then
    echo "Alter Container mit CTID $NEXT_CID gefunden, lösche ihn..."
    pct stop $NEXT_CID
    pct destroy $NEXT_CID
fi

# Container erstellen
echo "Erstelle Container..."
pct create $NEXT_CID "/var/lib/vz/template/cache/$TEMPLATE" \
    --storage $STORAGE \
    --hostname frigate \
    --cores 2 \
    --memory 4096 \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --unprivileged 1 \
    --features nesting=1 \
    --ostype debian \
    --password 'changeme'

pct start $NEXT_CID

# Docker & Git installieren
echo "Installiere Docker im Container..."
pct exec $NEXT_CID -- bash -c "apt update && apt install -y docker.io docker-compose git"

# Verzeichnisse für Frigate
pct exec $NEXT_CID -- mkdir -p /opt/frigate/config /opt/frigate/media

# Frigate starten
pct exec $NEXT_CID -- /opt/frigate/frigate-helper start

# Container-IP ausgeben
IP=$(pct exec $NEXT_CID -- hostname -I | awk '{print $1}')
echo "-----------------------------------"
echo "Frigate läuft im Container!"
echo "Zugriff: http://$IP:5000"
echo "CTID: $NEXT_CID"
echo "-----------------------------------"
