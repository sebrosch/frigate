#!/bin/bash
set -e

# Prüfen ob whiptail installiert ist
if ! command -v whiptail &>/dev/null; then
    echo "whiptail wird benötigt. Installiere..."
    apt update && apt install -y whiptail
fi

# 1️⃣ Container-ID abfragen
CTID=$(whiptail --inputbox "Container-ID (CTID) eingeben:" 8 40 112 --title "Frigate LXC Helper" 3>&1 1>&2 2>&3)

# 2️⃣ Debian Templates anzeigen
TEMPLATES=($(ls /var/lib/vz/template/cache/debian-*.tar.zst))
TEMPLATE=$(whiptail --menu "Wähle Debian Template:" 15 60 4 $(for t in "${TEMPLATES[@]}"; do echo "$t $t"; done) --title "Frigate LXC Helper" 3>&1 1>&2 2>&3)

# 3️⃣ Storage auswählen
STORAGES=($(pct storage list | awk '{print $1}'))
STORAGE=$(whiptail --menu "Wähle Storage:" 15 60 4 $(for s in "${STORAGES[@]}"; do echo "$s $s"; done) --title "Frigate LXC Helper" 3>&1 1>&2 2>&3)

# 4️⃣ Netzwerktyp auswählen
NET_TYPE=$(whiptail --radiolist "Netzwerktyp:" 15 60 2 \
"dhcp" "DHCP (automatische IP)" ON \
"statisch" "Statische IP" OFF --title "Frigate LXC Helper" 3>&1 1>&2 2>&3)

if [ "$NET_TYPE" == "statisch" ]; then
    STATIC_IP=$(whiptail --inputbox "IP-Adresse (z.B. 192.168.1.100/24) eingeben:" 8 40 --title "Frigate LXC Helper" 3>&1 1>&2 2>&3)
    GATEWAY=$(whiptail --inputbox "Gateway (z.B. 192.168.1.1) eingeben:" 8 40 --title "Frigate LXC Helper" 3>&1 1>&2 2>&3)
fi

# 5️⃣ Container erstellen
if [ "$NET_TYPE" == "dhcp" ]; then
    pct create $CTID /var/lib/vz/template/cache/$TEMPLATE -storage $STORAGE -net0 name=eth0,bridge=vmbr0
else
    pct create $CTID /var/lib/vz/template/cache/$TEMPLATE -storage $STORAGE -net0 name=eth0,bridge=vmbr0,ip=$STATIC_IP,gw=$GATEWAY
fi

pct start $CTID
sleep 5

# 6️⃣ Netzwerk prüfen
if ! pct exec $CTID -- ping -c 1 8.8.8.8 &>/dev/null; then
    whiptail --msgbox "Keine Netzwerkverbindung erkannt. Bitte Netzwerkkonfiguration prüfen." 8 40
    exit 1
fi

# 7️⃣ Docker installieren
pct exec $CTID -- bash -c "apt update && apt install -y curl gnupg lsb-release"
pct exec $CTID -- bash -c "curl -fsSL https://get.docker.com | sh"

# 8️⃣ Frigate starten
if whiptail --yesno "Frigate direkt im Container starten?" 8 40; then
    pct exec $CTID -- bash -c "docker run -d --name frigate -p 5000:5000 blakeblackshear/frigate:stable"
    whiptail --msgbox "Frigate läuft jetzt unter http://<IP>:5000" 8 40
fi

whiptail --msgbox "=== Fertig! Container $CTID ist bereit ===" 8 40
