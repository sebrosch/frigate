#!/bin/bash
# Frigate Helper für Proxmox LXC
# Version: 2.0
# Autor: angepasst für interaktive Template- und Storage-Auswahl

set -e

FRIGATE_DIR="/opt/frigate"
CONTAINER_NAME="frigate"
CTID=$(pvesh get /cluster/nextid)
TEMPLATE_DIR="/var/lib/vz/template/cache"

# Prüfen, ob jq installiert ist
if ! command -v jq &>/dev/null; then
    echo "jq wird benötigt, installiere..."
    apt update && apt install -y jq
fi

# Alte Version entfernen
if [ -d "$FRIGATE_DIR" ]; then
    echo "Altes $FRIGATE_DIR Verzeichnis gefunden, lösche es..."
    rm -rf "$FRIGATE_DIR"
fi

# Repo klonen
git clone https://github.com/sebrosch/frigate.git "$FRIGATE_DIR" --branch main
chmod +x "$FRIGATE_DIR/frigate-helper"

# Debian Templates auflisten
echo "Verfügbare Debian-Templates:"
templates=($(ls $TEMPLATE_DIR/debian-*-standard_*.tar.zst 2>/dev/null))
select TEMPLATE in "${templates[@]}"; do
    if [ -n "$TEMPLATE" ]; then
        echo "Gewähltes Template: $TEMPLATE"
        break
    fi
done

# Storage auswählen
storages=($(pvesh get /storage --output-format=json | jq -r '.[].storage'))
echo "Verfügbare Storage:"
select STORAGE in "${storages[@]}"; do
    if [ -n "$STORAGE" ]; then
        echo "Gewählter Storage: $STORAGE"
        break
    fi
done

# Container erstellen
echo "Erstelle Container CTID $CTID auf Storage $STORAGE mit Template $TEMPLATE..."
pct create $CTID "$TEMPLATE" -storage "$STORAGE" -hostname "$CONTAINER_NAME" -net0 name=eth0,bridge=vmbr0,ip=dhcp -cores 2 -memory 2048 -features nesting=1
pct start $CTID

# Docker installieren
echo "Installiere Docker im Container..."
pct exec $CTID -- bash -c "apt update && apt install -y docker.io"

# Frigate starten (im Container)
echo "Starte Frigate im Container..."
pct exec $CTID -- bash -c "docker run -d --name frigate --restart=unless-stopped -p 5000:5000 -v /etc/frigate:/config blakeblackshear/frigate:stable"

# IP anzeigen
IP=$(pct exec $CTID -- hostname -I | awk '{print $1}')
echo "-----------------------------------"
echo "Frigate läuft im Container!"
echo "Zugriff: http://$IP:5000"
echo "CTID: $CTID"
echo "-----------------------------------"
