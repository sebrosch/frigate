#!/bin/bash

# ---------------------------
# Frigate Helper Script v2.0
# Features:
# - Storage Option
# - Help-Menü
# - Prüft und lädt fehlendes LXC-Template
# - Löscht ggf. alte Container und /opt/frigate
# ---------------------------

STORAGE="local-lvm"
TEMPLATE="/var/lib/vz/template/cache/debian-12-standard_12.2-1_amd64.tar.gz"
FRIGATE_DIR="/opt/frigate"

show_help() {
    echo "Usage: $0 create [--storage STORAGE_NAME]"
    echo ""
    echo "Options:"
    echo "  --storage STORAGE_NAME   Wähle den Proxmox Storage für den Container (Default: local-lvm)"
    echo "  --help                   Zeigt dieses Hilfemenü"
    exit 0
}

# Parameter auslesen
while [[ $# -gt 0 ]]; do
    case $1 in
        --storage)
            STORAGE="$2"
            shift 2
            ;;
        --help)
            show_help
            ;;
        create)
            ACTION="create"
            shift
            ;;
        *)
            echo "Unbekannte Option: $1"
            show_help
            ;;
    esac
done

if [[ "$ACTION" != "create" ]]; then
    show_help
fi

echo "=== Starte Frigate Installation ==="
echo "Verwende Storage: $STORAGE"

# Prüfen, ob /opt/frigate existiert
if [ -d "$FRIGATE_DIR" ]; then
    echo "Altes /opt/frigate Verzeichnis gefunden, lösche es..."
    rm -rf "$FRIGATE_DIR"
fi

# Git-Klon erstellen
echo "Klonen des Repos..."
git clone git@github.com:sebrosch/frigate.git "$FRIGATE_DIR" --branch main

chmod +x "$FRIGATE_DIR/frigate-helper"

# Prüfen, ob LXC-Template existiert
if [ ! -f "$TEMPLATE" ]; then
    echo "LXC Template fehlt, lade es herunter..."
    pveam update
    pveam download local debian-12-standard_12.2-1_amd64.tar.gz
fi

# CTID ermitteln
NEXT_CID=$(pvesh get /cluster/nextid)
echo "CTID: $NEXT_CID"

# Prüfen, ob Container existiert
if pct status $NEXT_CID &>/dev/null; then
    echo "Alter Container mit CTID $NEXT_CID gefunden, lösche ihn..."
    pct stop $NEXT_CID
    pct destroy $NEXT_CID
fi

# LXC erstellen
echo "Erstelle Container..."
pct create $NEXT_CID "$TEMPLATE" \
    --storage $STORAGE \
    --hostname frigate \
    --cores 2 \
    --memory 4096 \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --unprivileged 1 \
    --features nesting=1 \
    --ostype debian \
    --password 'changeme'

pct start $NEXT_CID

# Docker installieren
echo "Installiere Docker im Container..."
pct exec $NEXT_CID -- bash -c "apt update && apt install -y docker.io docker-compose git"

# Verzeichnisse für Frigate
pct exec $NEXT_CID -- mkdir -p /opt/frigate/config /opt/frigate/media

# Frigate starten
pct exec $NEXT_CID -- /opt/frigate/frigate-helper start

# Container-IP ausgeben
IP=$(pct exec $NEXT_CID -- hostname -I | awk '{print $1}')
echo "-----------------------------------"
echo "Frigate läuft im Container!"
echo "Zugriff: http://$IP:5000"
echo "CTID: $NEXT_CID"
echo "-----------------------------------"
