#!/bin/bash

# ---------------------------
# Frigate Helper Script v7.0 (öffentlich, Template-Download automatisch)
# ---------------------------

STORAGE="local-lvm"
TEMPLATE="debian-12-standard_12.2-1_amd64.tar.gz"
FRIGATE_DIR="/opt/frigate"
GITHUB_REPO="frigate"

show_help() {
    echo "Usage: $0 create [--storage STORAGE_NAME]"
    echo ""
    echo "Options:"
    echo "  --storage STORAGE_NAME   Wähle den Proxmox Storage für den Container (Default: local-lvm)"
    echo "  --help                   Zeigt dieses Hilfemenü"
    exit 0
}

# Parameter auslesen
while [[ $# -gt 0 ]]; do
    case $1 in
        --storage)
            STORAGE="$2"
            shift 2
            ;;
        --help)
            show_help
            ;;
        create)
            ACTION="create"
            shift
            ;;
        *)
            echo "Unbekannte Option: $1"
            show_help
            ;;
    esac
done

if [[ "$ACTION" != "create" ]]; then
    show_help
fi

echo "=== Starte Frigate Installation ==="
echo "Verwende Storage: $STORAGE"

# Prüfen /opt/frigate
if [ -d "$FRIGATE_DIR" ]; then
    echo "Altes /opt/frigate Verzeichnis gefunden, lösche es..."
    rm -rf "$FRIGATE_DIR"
fi

# Repo klonen (öffentlich)
echo "Klonen des öffentlichen Repos..."
git clone https://github.com/sebrosch/$GITHUB_REPO.git "$FRIGATE_DIR" --branch main
chmod +x "$FRIGATE_DIR/frigate-helper"

# LXC Template prüfen und ggf. automatisch laden
TEMPLATE_PATH="/var/lib/vz/template/cache/$TEMPLATE"
if [ ! -f "$TEMPLATE_PATH" ]; then
    echo "LXC Template '$TEMPLATE' nicht gefunden auf Storage '$STORAGE'. Lade es automatisch herunter..."
    pveam update
    if ! pveam download $STORAGE $TEMPLATE; then
        echo "Fehler: Template-Download fehlgeschlagen. Bitte überprüfe Storage '$STORAGE' und Internetverbindung."
        exit 1
    fi
fi

# CTID ermitteln
NEXT_CID=$(pvesh get /cluster/nextid)
echo "CTID: $NEXT_CID"

# Prüfen, ob Container existiert
if pct status $NEXT_CID &>/dev/null; then
    echo "Alter Container mit CTID $NEXT_CID gefunden, lösche ihn..."
    pct stop $NEXT_CID
    pct destroy $NEXT_CID
fi

# Container erstellen
echo "Erstelle Container..."
pct create $NEXT_CID "$TEMPLATE_PATH" \
    --storage $STORAGE \
    --hostname frigate \
    --cores 2 \
    --memory 4096 \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --unprivileged 1 \
    --features nesting=1 \
    --ostype debian \
    --password 'changeme'

pct start $NEXT_CID

# Docker & Git installieren
echo "Installiere Docker im Container..."
pct exec $NEXT_CID -- bash -c "apt update && apt install -y docker.io docker-compose git"

# Verzeichnisse für Frigate
pct exec $NEXT_CID -- mkdir -p /opt/frigate/config /opt/frigate/media

# Frigate starten
pct exec $NEXT_CID -- /opt/frigate/frigate-helper start

# Container-IP ausgeben
IP=$(pct exec $NEXT_CID -- hostname -I | awk '{print $1}')
echo "-----------------------------------"
echo "Frigate läuft im Container!"
echo "Zugriff: http://$IP:5000"
echo "CTID: $NEXT_CID"
echo "-----------------------------------"
