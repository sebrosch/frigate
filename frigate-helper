#!/bin/bash
# Vollautomatischer Frigate LXC Installer für Proxmox (inkl. Docker-Compose Start)

set -e

echo "=== Vollautomatischer Frigate LXC Installer ==="

# 1. Netzwerk prüfen
echo "Prüfe Internetzugang..."
if ping -c 2 8.8.8.8 &> /dev/null; then
    echo "Internetverbindung OK"
else
    echo "Keine Internetverbindung! Bitte prüfen."
    exit 1
fi

# 2. LXC Template auswählen / herunterladen
echo
echo "=== LXC Template ==="
TEMPLATE="debian-12-standard_12.7-1_amd64.tar.zst"
TEMPLATE_PATH="/var/lib/vz/template/cache/$TEMPLATE"

if [ ! -f "$TEMPLATE_PATH" ]; then
    echo "Template nicht gefunden. Lade herunter..."
    pveam update
    pveam download local "$TEMPLATE"
else
    echo "Template bereits vorhanden: $TEMPLATE_PATH"
fi

# 3. Container-Parameter abfragen
echo
read -p "Bitte Container-ID (z.B. 112) eingeben: " CTID
read -p "Hostname für Container: " HOSTNAME
read -p "RAM in MB (z.B. 4096): " RAM
read -p "CPU-Kerne (z.B. 2): " CORES
read -p "Rootfs Größe in GB (z.B. 8): " ROOTFS
read -p "Bridge Interface (z.B. vmbr0): " BRIDGE

# 4. Container erstellen
echo
echo "Erstelle Container $CTID..."
pct create $CTID "$TEMPLATE_PATH" \
    --hostname "$HOSTNAME" \
    --memory "$RAM" \
    --swap 512 \
    --cores "$CORES" \
    --net0 name=eth0,bridge="$BRIDGE",ip=dhcp \
    --rootfs local-lvm:"$ROOTFS" \
    --features nesting=1

# 5. Container starten
pct start $CTID

# 6. Docker + Frigate Installation im Container automatisch
echo
echo "Installiere Docker & Frigate im Container..."
pct exec $CTID -- bash -c "
    set -e
    apt update && apt upgrade -y
    apt install -y sudo curl lsb-release gnupg git
    curl -fsSL https://get.docker.com | sh
    systemctl enable docker
    systemctl start docker
    apt install -y docker-compose
    git clone https://github.com/blakeblackshear/frigate.git /opt/frigate
    cd /opt/frigate
    docker-compose up -d
"

# 7. Fertigmeldung
echo
echo "=== Fertig! ==="
echo "Container $CTID läuft mit Frigate."
echo "Frigate WebUI erreichbar auf der IP des Containers Port 5000."
echo "Beispiel: http://<CONTAINER_IP>:5000"
echo "Direkter Login in den Container: pct console $CTID"
