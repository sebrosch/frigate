#!/bin/bash

# ---------------------------
# Frigate Helper Script v1.0
# Angepasst: Storage Option + Help
# ---------------------------

# Default Storage
STORAGE="local-lvm"

# Help-Menü
show_help() {
    echo "Usage: $0 create [--storage STORAGE_NAME]"
    echo ""
    echo "Options:"
    echo "  --storage STORAGE_NAME   Wähle den Proxmox Storage für den Container (Default: local-lvm)"
    echo "  --help                   Zeigt dieses Hilfemenü"
    exit 0
}

# Parameter auslesen
while [[ $# -gt 0 ]]; do
    case $1 in
        --storage)
            STORAGE="$2"
            shift 2
            ;;
        --help)
            show_help
            ;;
        create)
            ACTION="create"
            shift
            ;;
        *)
            echo "Unbekannte Option: $1"
            show_help
            ;;
    esac
done

# Prüfen ob Action gesetzt ist
if [[ "$ACTION" != "create" ]]; then
    show_help
fi

# ---------------------------
# CREATE-Teil (original übernommen)
# ---------------------------

echo "=== Starte Frigate Installation ==="
echo "Verwende Storage: $STORAGE"

# Beispiel: LXC erstellen (CTID automatisch ermitteln)
NEXT_CID=$(pvesh get /cluster/nextid)
echo "Erstelle Container mit CTID: $NEXT_CID"

pct create $NEXT_CID /var/lib/vz/template/cache/debian-12-standard_12.2-1_amd64.tar.gz \
    --storage $STORAGE \
    --hostname frigate \
    --cores 2 \
    --memory 4096 \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --unprivileged 1 \
    --features nesting=1 \
    --ostype debian \
    --password 'changeme'

echo "Starte Container..."
pct start $NEXT_CID

# Docker installieren und Frigate vorbereiten
echo "Installiere Docker im Container..."
pct exec $NEXT_CID -- bash -c "apt update && apt install -y docker.io docker-compose"

# Verzeichnisse für Frigate anlegen
pct exec $NEXT_CID -- mkdir -p /opt/frigate/config /opt/frigate/media

# Config von GitHub laden
pct exec $NEXT_CID -- bash -c "git clone https://github.com/sebrosch/frigate.git /opt/frigate --branch main"

# Frigate Helper im Container ausführbar machen
pct exec $NEXT_CID -- chmod +x /opt/frigate/frigate-helper

# Frigate starten
pct exec $NEXT_CID -- /opt/frigate/frigate-helper start

# Container IP anzeigen
IP=$(pct exec $NEXT_CID -- hostname -I | awk '{print $1}')
echo "-----------------------------------"
echo "Frigate läuft im Container!"
echo "Zugriff: http://$IP:5000"
echo "CTID: $NEXT_CID"
echo "-----------------------------------"

