#!/bin/bash
set -e

# Prüfen, ob whiptail installiert ist
if ! command -v whiptail &> /dev/null; then
    apt update && apt install -y whiptail
fi

# Template-Auswahl
TEMPLATE=$(whiptail --title "Frigate Installation" --menu "Wähle ein Debian Template:" 15 60 4 \
"debian-12-standard_12.7-1_amd64.tar.zst" "" \
"debian-12-standard_12.11-1_amd64.tar.zst" "" 3>&1 1>&2 2>&3)

# Storage Auswahl aus Proxmox Storage.cfg
STORAGE_LIST=$(grep 'type' /etc/pve/storage.cfg | awk '{print $1}')
STORAGE=$(whiptail --title "Storage Auswahl" --menu "Wähle einen Storage für den Container:" 15 60 4 \
$(for s in $STORAGE_LIST; do echo "$s"; done) 3>&1 1>&2 2>&3)

# VMID Auswahl
VMID=$(whiptail --inputbox "Gib die VMID für den Container ein:" 8 40 112 3>&1 1>&2 2>&3)

# Netzwerk
NET_TYPE=$(whiptail --title "Netzwerk" --menu "DHCP oder feste IP?" 10 40 2 \
"dhcp" "DHCP" \
"static" "Feste IP" 3>&1 1>&2 2>&3)

if [ "$NET_TYPE" == "static" ]; then
    IP_ADDR=$(whiptail --inputbox "Gib die feste IP-Adresse ein (z.B. 192.168.1.100/24):" 8 40 192.168.1.100 3>&1 1>&2 2>&3)
    GATEWAY=$(whiptail --inputbox "Gib das Gateway ein (z.B. 192.168.1.1):" 8 40 192.168.1.1 3>&1 1>&2 2>&3)
fi

# Container erstellen
echo "Erstelle LXC Container $VMID auf Storage $STORAGE..."
if [ "$NET_TYPE" == "dhcp" ]; then
    pct create $VMID /var/lib/vz/template/cache/$TEMPLATE -storage $STORAGE -net0 name=eth0,bridge=vmbr0,ip=dhcp
else
    pct create $VMID /var/lib/vz/template/cache/$TEMPLATE -storage $STORAGE -net0 name=eth0,bridge=vmbr0,ip=$IP_ADDR,gw=$GATEWAY
fi

# Container starten
pct start $VMID

# Docker Installation im Container
echo "Installiere Docker im Container $VMID..."
pct exec $VMID -- bash -c "apt update && apt install -y curl gnupg lsb-release && curl -fsSL https://get.docker.com | sh"

# Frigate Docker Container starten
echo "Starte Frigate im Container $VMID..."
pct exec $VMID -- bash -c "docker pull blakeblackshear/frigate:stable && \
docker run -d --name frigate --restart=unless-stopped \
--privileged \
--device /dev/bus/usb:/dev/bus/usb \
-p 5000:5000 \
-v /mnt/frigate/config:/config \
-v /mnt/frigate/clips:/clips \
-v /mnt/frigate/recordings:/recordings \
blakeblackshear/frigate:stable"

echo "Frigate Container $VMID ist fertig!"
if [ "$NET_TYPE" == "dhcp" ]; then
    echo "Zugriff: http://<Container_IP>:5000 (IP per DHCP vom Proxmox)"
else
    echo "Zugriff: http://$IP_ADDR:5000"
fi
